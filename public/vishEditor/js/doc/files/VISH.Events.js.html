<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>VISH.Events.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/VISH.Editor.html">VISH.Editor</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/ViSH.html">ViSH</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: VISH.Events.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
VISH.Events = (function(V,$,undefined){
	var bindedEventListeners = false;
	var PM_TOUCH_SENSITIVITY = 200; &#x2F;&#x2F;initially this was 15
	var MINIMUM_ZOOM_TO_ENABLE_SCROLL = 1.2; 
	var registeredEvents = [];

	var init = function() {
	  if(!V.Editing){
	  	bindViewerEventListeners();
	  }
	};

	&#x2F;* Register events *&#x2F;
	var _registerEvent = function(eventTargetId){
		if(registeredEvents.indexOf(eventTargetId)==-1){
			registeredEvents.push(eventTargetId);
		}
	};

	var _unregisterEvent = function(eventTargetId){
		if(registeredEvents.indexOf(eventTargetId)!=-1){
			registeredEvents.splice(registeredEvents.indexOf(eventTargetId), 1);
		}
	};

	&#x2F;* Event listeners *&#x2F;
	var handleBodyKeyDown = function(event) {
		switch (event.keyCode) {
			case 38: &#x2F;&#x2F; up arrow
			case 39: &#x2F;&#x2F; right arrow	    
				V.Slides.forwardOneSlide();
				event.preventDefault();
				break;
			case 37: &#x2F;&#x2F; left arrow
			case 40: &#x2F;&#x2F; down arrow
				V.Slides.backwardOneSlide();
				event.preventDefault();    		
				break;
		}
	};


	&#x2F;* Touch events *&#x2F;

	&#x2F;* Get the touches of an event
	 * Jquery does not pass the touches property in the event, and we get them from the event.originalEvent
	 *&#x2F;
	var getTouches = function (event){
		if(event.touches){
			return event.touches;
		} else if(event.originalEvent.touches){
			return event.originalEvent.touches;
		} else{
			return null;
		}
	};


	var handleTouchStart = function(event) {
		var touches = getTouches(event);
		if (touches.length === 1) {
			touchDX = 0;
			touchDY = 0;

			touchStartX = touches[0].pageX;
			touchStartY = touches[0].pageY;

			document.body.addEventListener(&#x27;touchmove&#x27;, handleTouchMove, true);
			document.body.addEventListener(&#x27;touchend&#x27;, handleTouchEnd, true);
			var zoom = document.documentElement.clientWidth &#x2F; window.innerWidth;

			&#x2F;&#x2F;TODO: Consider all of the event.target classes
			var firstClass = $(event.target).attr(&quot;class&quot;).split(&quot; &quot;)[0];
			var eventNotRegister = ((registeredEvents.indexOf(event.target.id)==-1)&amp;&amp;((registeredEvents.indexOf(firstClass)==-1)));

			if(zoom &lt; MINIMUM_ZOOM_TO_ENABLE_SCROLL &amp;&amp; eventNotRegister){
				&#x2F;&#x2F; alert(&quot;Prevent default&quot;)
				&#x2F;&#x2F; alert(firstClass);
				&#x2F;&#x2F;this is because if not done, the browser can take control of the event and cancels it, 
				&#x2F;&#x2F;because it thinks that the touch is a scroll action, so we prevent default if the zoom is lower than 1.5, 
				&#x2F;&#x2F;and there will be no scroll below that zoom level
				event.preventDefault();
			} else {
				&#x2F;&#x2F;Fix for Iphone devices due to Click Delegation bug
				if((VISH.Status.getDevice().iPhone)&amp;&amp;(VISH.Status.getDevice().browser.name===VISH.Constant.SAFARI)){
					if($(event.target).hasClass(&quot;fc_poi&quot;)){
						var poiId = event.target.id;
						_onFlashcardPoiClicked(poiId);
					} else if($(event.target).hasClass(&quot;close_subslide&quot;)){
						_onFlashcardCloseSlideClicked(event);
					}
				}
			}
		}
	};

	var handleTouchMove = function(event) {
		var touches = getTouches(event);
		if (touches.length &gt; 1) {
			cancelTouch();
		} else {
			touchDX = touches[0].pageX - touchStartX;
			touchDY = touches[0].pageY - touchStartY;
			var zoom = document.documentElement.clientWidth &#x2F; window.innerWidth;	  	
			if(zoom &lt; MINIMUM_ZOOM_TO_ENABLE_SCROLL){
				&#x2F;&#x2F;this is because if not done, the browser can take control of the event and cancels it, because it thinks that the touch is a scroll action
				event.preventDefault();
			}
		}
	};

	var handleTouchEnd = function(event) {	
		var dx = Math.abs(touchDX);
		var dy = Math.abs(touchDY);

		if ((dx &gt; PM_TOUCH_SENSITIVITY) &amp;&amp; (dy &lt; (dx * 2 &#x2F; 3))) {

			&#x2F;&#x2F;Close subslide if is open
			var subslide = V.Slides.getCurrentSubSlide();
			if(subslide!==null){
				V.Slides.closeSubslide($(subslide).attr(&quot;id&quot;));
			}

			if (touchDX &gt; 0) {
				V.Slides.backwardOneSlide();
			} else {
				V.Slides.forwardOneSlide();
			}
		}
		cancelTouch();
	};

	var cancelTouch = function() {
	  document.body.removeEventListener(&#x27;touchmove&#x27;, handleTouchMove, true);
	  document.body.removeEventListener(&#x27;touchend&#x27;, handleTouchEnd, true); 
	};

	&#x2F;**
	 * function called when a poi is clicked
	 * &#x27;event&#x27; can be a delegate click event or a number
	 *&#x2F;
	 var _onFlashcardPoiClicked = function(event){
	 	if(typeof event === &quot;string&quot;){
	 		var poiId = event;
	 	} else if(typeof event === &quot;object&quot;){
	 		var poiId = event.data.poi_id;
	 	} else {
	 		return;
	 	}
	 	var poi = VISH.Flashcard.getPoiData(poiId);
	 	if(poi!==null){
	 		V.Slides.openSubslide(poi.slide_id,true);
	 	}
	 };


   var _onFlashcardCloseSlideClicked = function(event){
	    var close_slide_id = event.target.id.substring(5); &#x2F;&#x2F;the id is close3
	    V.Slides.closeSubslide(close_slide_id,true);
   };


   var bindViewerEventListeners = function(){
   		if(!bindedEventListeners){
			$(document).bind(&#x27;keydown&#x27;, handleBodyKeyDown); 
      		$(document).on(&#x27;click&#x27;, &#x27;#page-switcher-start&#x27;, V.Slides.backwardOneSlide);
      		$(document).on(&#x27;click&#x27;, &#x27;#page-switcher-end&#x27;, V.Slides.forwardOneSlide);
      		$(document).on(&#x27;click&#x27;, &#x27;#back_arrow&#x27;, V.Slides.backwardOneSlide);
      		_registerEvent(&quot;back_arrow&quot;);
      		$(document).on(&#x27;click&#x27;, &#x27;#forward_arrow&#x27;, V.Slides.forwardOneSlide);	
      		_registerEvent(&quot;forward_arrow&quot;);
      		_registerEvent(&quot;closeButton&quot;);
      		_registerEvent(&quot;closeButtonImg&quot;);
      		$(document).on(&#x27;click&#x27;, &#x27;#closeButton&#x27;, function(){
      			window.top.location.href = V.SlideManager.getOptions()[&quot;comeBackUrl&quot;];
      		});
 			$(document).bind(&#x27;touchstart&#x27;, handleTouchStart); 
 			$(document).on(&#x27;click&#x27;,&#x27;.close_subslide&#x27;, _onFlashcardCloseSlideClicked);
 			_registerEvent(&quot;close_subslide&quot;);

 			&#x2F;&#x2F;Register events for custom video player
 			_registerEvent(&quot;customPlayerButton&quot;);
 			_registerEvent(&quot;customPlayerControls&quot;);
	      	
	      	var presentation = V.SlideManager.getCurrentPresentation();
	      	for(index in presentation.slides){
	      		var slide = presentation.slides[index];
      			switch(slide.type){
      				case VISH.Constant.FLASHCARD:
	      				&#x2F;&#x2F;Add the points of interest with their click events to show the slides
		  				for(ind in slide.pois){
		  					var poi = slide.pois[ind];
		  					$(document).on(&#x27;click&#x27;, &quot;#&quot; + poi.id,  { poi_id: poi.id}, _onFlashcardPoiClicked);
		  					_registerEvent(poi.id);
		  				}
      					break;
      				case VISH.Constant.VTOUR:
      					break;
      			}
  		    }

  		    &#x2F;&#x2F;when page is cached or updated, add presentation to localstorage
  		    if(applicationCache){
  		    	applicationCache.addEventListener(&#x27;cached&#x27;, function() {VISH.LocalStorage.addPresentation(presentation);}, false);
				applicationCache.addEventListener(&#x27;updateready&#x27;, function() {VISH.LocalStorage.addPresentation(presentation);}, false);
  		    }

    		if (!V.Status.getDevice().desktop){
				bindMobileViewerEventListeners();
			}
		} 
		bindedEventListeners = true;
   }

	var bindMobileViewerEventListeners = function(){
		window.addEventListener(&quot;load&quot;, 				function(){ _hideAddressBar(); } );
		window.addEventListener(&quot;orientationchange&quot;, 	function(){ _hideAddressBar(); } );
		$(window).on(&#x27;orientationchange&#x27;,function(){
			V.ViewerAdapter.setupSize();      
		});
	}

	var _hideAddressBar = function(){ 
		&#x2F;&#x2F;TODO
		&#x2F;*
		if(document.body.style.height &lt; window.outerHeight) {
			document.body.style.height = (window.outerHeight + 50) + &#x27;px&#x27;;
			VISH.Debugging.log(&quot;height &quot; + document.body.style.height);
		}

		setTimeout( function(){ 
			VISH.Debugging.log(&quot;scroll&quot;);
			window.scrollTo(0, 1); 
		}, 50 );
		*&#x2F;
	};

	var unbindViewerEventListeners = function(){
		if(bindedEventListeners){
			$(document).unbind(&#x27;keydown&#x27;, handleBodyKeyDown); 
			$(document).off(&#x27;click&#x27;, &#x27;#page-switcher-start&#x27;, V.Slides.backwardOneSlide);
	  		$(document).off(&#x27;click&#x27;, &#x27;#page-switcher-end&#x27;, V.Slides.forwardOneSlide);
	  		_unregisterEvent(&quot;back_arrow&quot;);
	  		$(document).off(&#x27;click&#x27;, &#x27;#back_arrow&#x27;, V.Slides.backwardOneSlide);
	  		_unregisterEvent(&quot;forward_arrow&quot;);
	  		$(document).off(&#x27;click&#x27;, &#x27;#forward_arrow&#x27;, V.Slides.forwardOneSlide);
	  		_unregisterEvent(&quot;closeButton&quot;);
	  		_unregisterEvent(&quot;closeButtonImg&quot;);
	  		$(document).off(&#x27;click&#x27;, &#x27;#closeButton&#x27;);
	  		$(document).unbind(&#x27;touchstart&#x27;, handleTouchStart); 
  		
  			var presentation = V.SlideManager.getCurrentPresentation();
	      	for(index in presentation.slides){
				if(presentation.slides[index].type === &quot;flashcard&quot;){
	  				for(ind in presentation.slides[index].pois){
	  					var poi = presentation.slides[index].pois[ind];
	  					$(document).off(&#x27;click&#x27;, &quot;#&quot; + poi.id,  { poi_id: poi.id}, _onFlashcardPoiClicked);
	  				}
	      			$(document).off(&#x27;click&#x27;,&#x27;.close_subslide&#x27;, _onFlashcardCloseSlideClicked);
      			}
  		    }
	  		bindedEventListeners = false;
		}
	};
	
	return {
			init 		: init,
			bindViewerEventListeners	: bindViewerEventListeners,
			unbindViewerEventListeners	: unbindViewerEventListeners
	};

}) (VISH,jQuery);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
